# Cortex-M23におけるTrustZone技術実装仕様

## 1. TrustZoneの基本概念

TrustZoneは、ハードウェアレベルでセキュリティを確保するArmのセキュリティ技術です。<br>
システムリソースを「Secure」と「Non-secure」の2つの実行状態（セキュリティステート）に分離します。

### 1.1 主な特徴
- プロセッサの実行状態を「Secure」と「Non-secure」に分離
- メモリやペリフェラルへのアクセスを制御
- ハードウェアレベルでの分離により、高い安全性を確保
- オペレーティングシステムに依存しない保護機能

## 2. Cortex-M23での実装

### 2.1 セキュリティ拡張機能（SECEXT）
- コンフィギュレーションパラメータSECEXTで有効/無効を設定
- デフォルトは有効（YES）
- セキュリティ拡張を有効にすると以下の機能が利用可能：
  - セキュアメモリ保護ユニット（MPU_S）
  - セキュリティ属性ユニット（SAU）
  - セキュア/ノンセキュアのVTOR（ベクターテーブルオフセットレジスタ）
  - セキュア/ノンセキュアのスタック

### 2.2 メモリ保護の実装
- セキュアMPU（MPU_S）
  - 最大16リージョンまで設定可能
  - セキュア状態のメモリアクセス制御
  - リージョン数は0,4,8,12,16から選択可能

- ノンセキュアMPU（MPU_NS）
  - 最大16リージョンまで設定可能
  - ノンセキュア状態のメモリアクセス制御
  - リージョン数は0,4,8,12,16から選択可能

### 2.3 セキュリティ属性ユニット（SAU）
- メモリ領域のセキュリティ属性を定義
- 最大8リージョンまで設定可能（0,4,8から選択）
- リージョンタイプ：
  - セキュア（S）
  - ノンセキュア（NS）
  - ノンセキュアコーラブル（NSC）

### 2.4 外部実装定義属性ユニット（IDAU）
- SAUと連携して動作
- 32バイト単位でメモリのセキュリティ属性を制御
- システム固有のセキュリティポリシーを実装可能
- 以下の信号を提供：
  - IDAUNSA/IDAUNSB: ノンセキュア領域応答
  - IDAUNSCA/IDAUNSCB: ノンセキュアコーラブル領域応答
  - IDAUIDA[7:0]: リージョン識別子
  - IDAUIDVA: リージョン番号有効
  - IDAUNCHKA/IDAUNCHKB: 属性チェック除外

### 2.5 セキュリティ状態の遷移
- セキュア→ノンセキュア：
  - SG命令を使用
  - 例外処理による遷移
  - 割り込み処理による遷移

- ノンセキュア→セキュア：
  - セキュアゲートウェイ（NSC領域）経由での呼び出し
  - セキュア例外処理
  - セキュア割り込み処理

### 2.6 バスインターフェースでのセキュリティ実装
- HNONSECシグナル：
  - LOW: セキュアトランザクション
  - HIGH: ノンセキュアトランザクション
  - セキュリティ拡張無効時は常にHIGH

- IONONSECシグナル（I/Oポート用）：
  - セキュア/ノンセキュアアクセスの制御
  - HNONSECと同様の動作

### 2.7 デバッグとトレースのセキュリティ
- デバッグ認証信号：
  - SPIDEN: セキュア侵襲デバッグ有効
  - SPNIDEN: セキュア非侵襲デバッグ有効
  - セキュアソフトウェアによる制御可能

## 3. セキュリティ設計のガイドライン

### 3.1 推奨される実装方法
1. SAUを使用した基本的なメモリ分離の実装
2. IDAUによるシステム固有のセキュリティポリシーの実装
3. MPU_SとMPU_NSによる詳細なアクセス制御の設定
4. デバッグアクセスの適切な制限

### 3.2 注意点
- リセット後、SAU_CTRL.ALLNSが0にリセットされ、PPB空間の特定領域を除くすべてのメモリがセキュア状態に
- SAU_CTRL.ALLNSビットを1に設定することで、IDAUによるセキュリティレベルの制御が可能に
- セキュアコードは必要最小限に抑えることを推奨
- NSC領域は慎重に設計し、必要な関数のみを公開
